name: Deploy Sambo Bot to Yandex Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: cr.yandex
  REGISTRY_ID: crpu0j7h3s904qarlc1j
  IMAGE_NAME: sambo-bot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Yandex Container Registry
      run: |
        echo "${{ secrets.YC_SA_JSON_KEY }}" | docker login \
          --username json_key \
          --password-stdin cr.yandex
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest .
    
    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Deploy to Yandex Serverless Container
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        export PATH=$PATH:$HOME/yandex-cloud/bin
        
        echo "${{ secrets.YC_SA_JSON_KEY }}" > key.json
        yc config profile create sa-profile
        yc config set service-account-key key.json
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        
        yc serverless container revision deploy \
          --container-id ${{ secrets.YC_CONTAINER_ID }} \
          --image ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest \
          --cores 1 \
          --memory 512MB \
          --execution-timeout 60s \
          --service-account-id ${{ secrets.YC_SA_ID }} \
          --environment TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
          --environment GOOGLE_SHEET_ID="${{ secrets.GOOGLE_SHEET_ID }}" \
          --environment TELEGRAM_USER_ID="${{ secrets.TELEGRAM_USER_ID }}" \
          --environment DEEPSEEK_API_KEY="${{ secrets.DEEPSEEK_API_KEY }}" \
          --environment GOOGLE_CREDENTIALS_JSON="${{ secrets.GOOGLE_CREDENTIALS_JSON }}"
        
        echo "Deployment completed successfully!"